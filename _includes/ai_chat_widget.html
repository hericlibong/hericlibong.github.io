<!-- AI Chat Widget -->
<div id="ai-chat-widget" class="ai-chat-widget">
  <div class="ai-chat-header">
    <div class="ai-chat-avatar">ü§ñ</div>
    <div class="ai-chat-title">Data Stories AI</div>
    <button class="ai-chat-close" onclick="toggleChatWidget()">√ó</button>
  </div>
  
  <div class="ai-chat-body">
    <div class="ai-chat-messages" id="ai-chat-messages">
      <div class="ai-chat-message ai-assistant">
        Bonjour ! Je suis votre assistant Data Stories. Je peux r√©pondre √† vos questions sur les articles, projets et le parcours de l'auteur. Comment puis-je vous aider ?
      </div>
    </div>
    
    <div class="ai-chat-input-area">
      <input type="text" id="ai-chat-input" class="ai-chat-input" 
             placeholder="Posez votre question sur les donn√©es, projets, etc..." 
             onkeypress="handleChatInput(event)">
      <button class="ai-chat-send" onclick="sendChatMessage()">‚Üí</button>
    </div>
  </div>
</div>

<div class="ai-chat-toggle" onclick="toggleChatWidget()">
  <div class="ai-chat-toggle-icon">ü§ñ</div>
  <div class="ai-chat-toggle-text">Data Stories AI</div>
</div>

<style>
/* AI Chat Widget Styles */
.ai-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  display: none;
  z-index: 10000;
  font-family: var(--body-font);
  max-height: 500px;
  overflow: hidden;
  flex-direction: column;
}

.ai-chat-widget.active {
  display: flex;
}

.ai-chat-header {
  background: linear-gradient(135deg, var(--hover-col), #0066cc);
  color: white;
  padding: 12px 15px;
  border-radius: 12px 12px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.ai-chat-avatar {
  font-size: 1.5rem;
  margin-right: 10px;
}

.ai-chat-title {
  font-weight: 600;
  font-size: 0.95rem;
  flex-grow: 1;
}

.ai-chat-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
}

.ai-chat-body {
  padding: 15px;
  overflow-y: auto;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.ai-chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  margin-bottom: 10px;
  padding-right: 5px;
}

.ai-chat-message {
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  line-height: 1.4;
  max-width: 85%;
}

.ai-chat-message.ai-user {
  background: var(--navbar-col);
  margin-left: auto;
  color: var(--text-col);
}

.ai-chat-message.ai-assistant {
  background: #f0f8ff;
  margin-right: auto;
  color: var(--text-col);
}

.ai-chat-input-area {
  display: flex;
  gap: 8px;
  margin-top: auto;
}

.ai-chat-input {
  flex-grow: 1;
  padding: 10px 12px;
  border: 1px solid var(--navbar-border-col);
  border-radius: 8px;
  font-family: var(--body-font);
  font-size: 0.9rem;
}

.ai-chat-input:focus {
  outline: none;
  border-color: var(--hover-col);
  box-shadow: 0 0 0 2px rgba(0, 138, 255, 0.2);
}

.ai-chat-send {
  background: var(--hover-col);
  color: white;
  border: none;
  border-radius: 8px;
  width: 40px;
  height: 40px;
  cursor: pointer;
  font-size: 1.1rem;
}

.ai-chat-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, var(--hover-col), #0066cc);
  color: white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  transition: all 0.3s ease;
}

.ai-chat-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

.ai-chat-toggle-icon {
  font-size: 1.5rem;
}

.ai-chat-toggle-text {
  font-size: 0.6rem;
  font-weight: 500;
  text-align: center;
}

.ai-chat-widget.active + .ai-chat-toggle {
  display: none;
}
</style>

<script>
// Chat widget functionality
function toggleChatWidget() {
  const widget = document.getElementById('ai-chat-widget');
  const toggle = document.querySelector('.ai-chat-toggle');
  widget.classList.toggle('active');
  toggle.style.display = widget.classList.contains('active') ? 'none' : 'flex';
}

async function sendChatMessage() {
  const input = document.getElementById('ai-chat-input');
  const message = input.value.trim();
  
  if (message) {
    addChatMessage(message, 'ai-user');
    input.value = '';
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'ai-chat-message ai-assistant';
    typingIndicator.id = 'typing-indicator';
    typingIndicator.innerHTML = '<div class="typing-dots"><span>‚óè</span><span>‚óè</span><span>‚óè</span></div>';
    document.getElementById('ai-chat-messages').appendChild(typingIndicator);
    
    // Scroll to bottom
    scrollChatToBottom();
    
    // Call the actual AI Worker
    await callAIWorker(message);
  }
}

async function callAIWorker(message) {
  try {
    // Get the API URL from site configuration
    const workerUrl = "{{ site.mistral_api_url }}";
    const corpusUrl = "{{ site.url | absolute_url }}/assets/data/ai_corpus.json";
    
    const response = await fetch(workerUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': window.location.origin
      },
      body: JSON.stringify({
        message: message,
        corpusUrl: corpusUrl
      })
    });
    
    const data = await response.json();
    
    removeTypingIndicator();
    
    if (data.success && data.response) {
      addChatMessage(data.response, 'ai-assistant');
    } else {
      addChatMessage(data.error || "D√©sol√©, je n'ai pas pu obtenir de r√©ponse. Veuillez r√©essayer.", 'ai-assistant');
    }
    
    scrollChatToBottom();
    
  } catch (error) {
    console.error('Error calling AI Worker:', error);
    removeTypingIndicator();
    addChatMessage("Une erreur est survenue. Veuillez v√©rifier votre connexion ou r√©essayer plus tard.", 'ai-assistant');
    scrollChatToBottom();
  }
}

function handleChatInput(event) {
  if (event.key === 'Enter') {
    sendChatMessage();
  }
}

function addChatMessage(message, className) {
  const messagesContainer = document.getElementById('ai-chat-messages');
  const messageElement = document.createElement('div');
  messageElement.className = `ai-chat-message ${className}`;
  messageElement.textContent = message;
  messagesContainer.appendChild(messageElement);
}

function removeTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    indicator.remove();
  }
}

function scrollChatToBottom() {
  const messagesContainer = document.getElementById('ai-chat-messages');
  setTimeout(() => {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 50);
}

// Add typing dots style
const style = document.createElement('style');
style.textContent = `
.typing-dots {
  display: flex;
  gap: 4px;
  justify-content: flex-start;
}

.typing-dots span {
  animation: typing 1.4s infinite ease-in-out;
  font-size: 1.2rem;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-5px); opacity: 1; }
}
`;
document.head.appendChild(style);
</script>